<Page
    x:Class="PowerToys.FileLocksmithUI.Views.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:PowerToys.FileLocksmithUI.Converters"
    xmlns:core="using:Microsoft.Xaml.Interactions.Core"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:interop="using:PowerToys.FileLocksmithLib.Interop"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:tkcontrols="using:CommunityToolkit.WinUI.Controls"
    xmlns:tkconverters="using:CommunityToolkit.WinUI.Converters"
    xmlns:ui="using:CommunityToolkit.WinUI"
    mc:Ignorable="d">
    <Page.Resources>
        <tkconverters:BoolToVisibilityConverter
            x:Key="boolToVisibilityConverter"
            FalseValue="Visible"
            TrueValue="Collapsed" />
        <tkconverters:BoolToVisibilityConverter
            x:Key="boolToVisibilityVisible"
            FalseValue="Collapsed"
            TrueValue="Visible" />

        <tkconverters:DoubleToVisibilityConverter
            x:Key="doubleToVisibilityConverter"
            FalseValue="Visible"
            GreaterThan="0"
            TrueValue="Collapsed" />
        <converters:FileCountConverter x:Key="fileCountConverter" />
        <converters:PidToIconConverter x:Key="pidToIconConverter" />
        <converters:UserToSystemWarningVisibilityConverter x:Key="userToSystemWarningVisibilityConverter" />
        <converters:FileListToDescriptionConverter x:Key="fileListToDescriptionConverter" />
    </Page.Resources>

    <interactivity:Interaction.Behaviors>
        <core:EventTriggerBehavior EventName="Loaded">
            <core:InvokeCommandAction Command="{x:Bind ViewModel.LoadProcessesCommand}" />
        </core:EventTriggerBehavior>
    </interactivity:Interaction.Behaviors>

    <Grid RowSpacing="16" Padding="24,16,24,24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Border
            Padding="16"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="12">
            <Grid RowSpacing="12" ColumnSpacing="16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Row="0" Grid.Column="0" Spacing="6">
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <FontIcon
                            FontSize="20"
                            Foreground="{ThemeResource SystemControlForegroundAccentBrush}"
                            Glyph="&#xE7B8;" />
                        <TextBlock Style="{ThemeResource TitleTextBlockStyle}" Text="File Locksmith" />
                    </StackPanel>
                    <TextBlock
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        Text="定位并解除文件/文件夹占用" />
                </StackPanel>

                <StackPanel
                    Grid.Row="0"
                    Grid.Column="1"
                    HorizontalAlignment="Right"
                    Orientation="Horizontal"
                    Spacing="8">
                    <Button
                        Command="{Binding LoadProcessesCommand}"
                        MinHeight="36"
                        Style="{StaticResource SubtleButtonStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon FontSize="16" Glyph="&#xE72C;" />
                            <TextBlock x:Uid="Reload" />
                        </StackPanel>
                    </Button>
                    <Button
                        x:Name="RestartAsAdminBtn"
                        Command="{Binding RestartElevatedCommand}"
                        MinHeight="36"
                        Style="{StaticResource SubtleButtonStyle}"
                        Visibility="{x:Bind ViewModel.IsElevated, Converter={StaticResource boolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon FontSize="16" Glyph="&#xE7EF;" />
                            <TextBlock x:Uid="RestartAsAdmin" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <Button
                    Grid.Row="1"
                    Grid.ColumnSpan="2"
                    HorizontalAlignment="Left"
                    MinHeight="40"
                    Padding="12,6"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Click="ShowSelectedPathsButton_Click">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon FontSize="16" Glyph="&#xE8A5;" />
                        <TextBlock
                            IsTextSelectionEnabled="False"
                            Style="{ThemeResource BodyStrongTextBlockStyle}"
                            Text="{x:Bind ViewModel.Paths, Converter={StaticResource fileListToDescriptionConverter}}"
                            TextTrimming="CharacterEllipsis" />
                    </StackPanel>
                    <ToolTipService.ToolTip>
                        <TextBlock x:Uid="PathsTooltipDescription" TextWrapping="WrapWholeWords" />
                    </ToolTipService.ToolTip>
                </Button>
            </Grid>
        </Border>

        <Border
            Grid.Row="1"
            Padding="12"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="12">
            <Grid>
                <Grid Visibility="{x:Bind ViewModel.IsLoading, Converter={StaticResource boolToVisibilityConverter}, Mode=OneWay}">
                    <ListView
                        x:Name="ProcessesListView"
                        Padding="4,4,4,12"
                        IncrementalLoadingThreshold="10"
                        ItemsSource="{x:Bind ViewModel.Processes}"
                        SelectionMode="None">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="interop:ProcessResult">
                                <Border
                                    Margin="0,0,0,10"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="10">
                                    <tkcontrols:SettingsExpander>
                                        <tkcontrols:SettingsExpander.Resources>
                                            <x:Double x:Key="SettingsCardWrapThreshold">0</x:Double>
                                        </tkcontrols:SettingsExpander.Resources>
                                        <tkcontrols:SettingsExpander.Header>
                                            <!--  We can't use the HeaderIcon because it only support a BitmapIcon, which only supports UriSource - not a direct BitmapImage  -->
                                            <StackPanel Spacing="4">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <Image
                                                        Width="16"
                                                        Height="16"
                                                        Source="{x:Bind pid, Converter={StaticResource pidToIconConverter}}" />
                                                    <TextBlock
                                                        IsTextSelectionEnabled="True"
                                                        Style="{ThemeResource BodyStrongTextBlockStyle}"
                                                        Text="{x:Bind name}" />
                                                </StackPanel>
                                                <StackPanel Orientation="Horizontal" Spacing="12">
                                                    <TextBlock
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                        Text="{x:Bind pid}" />
                                                    <TextBlock
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                        Text="{x:Bind user}" />
                                                </StackPanel>
                                            </StackPanel>
                                        </tkcontrols:SettingsExpander.Header>
                                        <tkcontrols:SettingsExpander.Content>
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon
                                                    Foreground="{ThemeResource InfoBarWarningSeverityIconBackground}"
                                                    Glyph="&#xE7BA;"
                                                    Visibility="{x:Bind user, Mode=OneTime, Converter={StaticResource userToSystemWarningVisibilityConverter}}">
                                                    <ToolTipService.ToolTip>
                                                        <TextBlock x:Uid="ProcessIsSystemUserWarning" TextWrapping="Wrap" />
                                                    </ToolTipService.ToolTip>
                                                </FontIcon>
                                                <Button
                                                    MinWidth="128"
                                                    MinHeight="36"
                                                    Command="{Binding Path=DataContext.EndTaskCommand, ElementName=ProcessesListView}"
                                                    CommandParameter="{Binding}">
                                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                                        <FontIcon FontSize="16" Glyph="&#xF140;" />
                                                        <TextBlock x:Uid="EndTask" />
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>
                                        </tkcontrols:SettingsExpander.Content>
                                        <tkcontrols:SettingsExpander.Items>
                                            <tkcontrols:SettingsCard x:Uid="ProcessID">
                                                <TextBlock
                                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                    IsTextSelectionEnabled="True"
                                                    Text="{x:Bind pid}" />
                                            </tkcontrols:SettingsCard>
                                            <tkcontrols:SettingsCard x:Uid="User">
                                                <TextBlock
                                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                    IsTextSelectionEnabled="True"
                                                    Text="{x:Bind user}" />
                                            </tkcontrols:SettingsCard>
                                            <tkcontrols:SettingsCard>
                                                <tkcontrols:SettingsCard.Header>
                                                    <TextBlock>
                                                        <Run x:Uid="Files" />
                                                        <Run Text="(" /><Run Text="{x:Bind files, Converter={StaticResource fileCountConverter}}" /><Run Text=")" />
                                                    </TextBlock>
                                                </tkcontrols:SettingsCard.Header>
                                                <Button Click="ShowProcessFiles_Click">
                                                    <TextBlock x:Uid="ShowProcessFiles" />
                                                </Button>
                                            </tkcontrols:SettingsCard>
                                        </tkcontrols:SettingsExpander.Items>
                                    </tkcontrols:SettingsExpander>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <StackPanel
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Orientation="Vertical"
                        Spacing="10"
                        Visibility="{x:Bind ViewModel.Processes.Count, Mode=OneWay, Converter={StaticResource doubleToVisibilityConverter}}">
                        <Border
                            Padding="12"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="999">
                            <FontIcon FontSize="28" Glyph="&#xE9F3;" />
                        </Border>
                        <TextBlock x:Uid="EmptyListDescription" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                        <Button
                            HorizontalAlignment="Center"
                            MinHeight="36"
                            Command="{Binding LoadProcessesCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <FontIcon FontSize="16" Glyph="&#xE72C;" />
                                <TextBlock x:Uid="Reload" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>

                <Grid
                    Background="{ThemeResource SystemControlBackgroundChromeLowBrush}"
                    Opacity="0.8"
                    Visibility="{x:Bind ViewModel.IsLoading, Converter={StaticResource boolToVisibilityVisible}, Mode=OneWay}">
                    <ProgressRing
                        Width="48"
                        Height="48"
                        IsActive="True"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center" />
                </Grid>
            </Grid>
        </Border>

        <ContentDialog x:Name="SelectedFilesListDialog" x:Uid="SelectedFilesListDialog">
            <TextBlock
                IsTextSelectionEnabled="True"
                Text="{x:Bind ViewModel.PathsToString, Mode=OneWay}"
                TextWrapping="Wrap" />
        </ContentDialog>
        <ContentDialog x:Name="ProcessFilesListDialog" x:Uid="ProcessFilesListDialog">
            <ScrollViewer Padding="16" HorizontalScrollBarVisibility="Auto">
                <TextBlock
                    x:Name="ProcessFilesListDialogTextBlock"
                    x:Uid="ProcessFilesListDialogTextBlock"
                    IsTextSelectionEnabled="True" />
            </ScrollViewer>
        </ContentDialog>
    </Grid>
</Page>
